<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<link rel="stylesheet" href="../dist/katex.min.css?ac=1" />
<style type="text/css">
		html,body{box-sizing: border-box; overflow-x: hidden;}
		*{margin: 0; padding: 0; list-style:none; outline: none}
		canvas{border:1px solid #ccc; margin: 0 auto; display: block}
		#c{padding:20px 50px; font-size: 16px; border:none;}
		#rstltx{padding: 10px; line-height: 25px;}
		button{border:none; width: 100px; height: 50px; margin: 0 auto; display: block; outline: none}
		.wave{background-color: #ccc; text-decoration: line-through }
		ul{width: 100%; height: 350px;}
		ul li{width: 50%; float: left; height:350px; box-sizing: border-box; text-align: center;}
		#inputlatex{width: 100%; display: block; height:60px; clear: both; box-sizing: border-box}
	</style>
</head>
<body>
	<ul>
		<li> <button id="clear">清空</button>
 		<canvas id="cs" width='400' height='300'></canvas></li>
		<li id="rstltx"></li>
	</ul>
   	<input type="text" id="inputlatex" placeholder="latex">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="./katex.min.js"></script>
	<script>
		 var parent = window.parent;
		    //dialog对象
		    dialog = parent.$EDITORUI[window.frameElement.id.replace( /_iframe$/, '' )];
		    //当前打开dialog的编辑器实例
		    editor = dialog.editor;
		    UE = parent.UE;

		    domUtils = UE.dom.domUtils;
		    utils = UE.utils;

		    browser = UE.browser;

		    ajax = UE.ajax;
		      dialog.onok = function(){
		      	 editor.execCommand("inserthtml",document.getElementById('rstltx').innerHTML);
		      }
	</script>
	<script>
		var cs = document.getElementById('cs'),ctx = cs.getContext("2d");
		var point = 0;
		var arrx = [];
		var arry = [];
		var post = {
				components:[]
		}
		var is = false;
		document.getElementById('clear').addEventListener("click",function(){ point=0; ctx.save(); ctx.clearRect(0,0,600,600);
			post.components = [];},false);
		cs.addEventListener("mousemove",function(e){
			if (!is) { return;}
			ctx.lineTo(e.pageX-e.target.offsetLeft,e.pageY-e.target.offsetTop);
			// ctx.beginPath()
			// ctx.arc(e.pageX,e.pageY,2,0,Math.PI*2);
			arry.push(e.pageY-e.target.offsetTop);
			arrx.push(e.pageX-e.target.offsetLeft);
			ctx.stroke();
			ctx.save();
			// ctx.fill();
		},false)
		cs.addEventListener("mousedown",function(e){
			is = true;
			ctx.beginPath();
			ctx.moveTo(e.pageX-e.target.offsetLeft,e.pageY-e.target.offsetTop);
			arrx = [];
			arry = [];
		},false);
		document.getElementById('inputlatex').addEventListener("keyup",function(){
			try{
				katex.render(document.getElementById('inputlatex').value, document.getElementById('rstltx'));
			}catch(e){
				// console.log(e)
			}
		},false);

		cs.addEventListener("mouseup",function(e){
			is = false;
		

			if (arry.length <5 &&  arrx.length <5) {
				return;
			}
			post.components[point] = {
				type:"stroke",
				x:arrx,
				y:arry
			}
			point++;
			try{
				$.ajax({
				type:"post",
				url:"http://myscript.willclass.com/api/myscript/v2.0/equation/doSimpleRecognition.json",
				data:"apiKey=cb0c0b23-607a-4342-ab04-142ca8365e57&equationInput="+JSON.stringify(post)+"&userId=16000000000",
				success:function(data){
					console.log(data.result.results[0].value);
					document.getElementById('inputlatex').value = data.result.results[0].value
					katex.render(data.result.results[0].value, document.getElementById('rstltx'));
				},
				error:function(){
					console.log(arguments)
				}
				})
			}catch(e){
				console.log(e);
			}
				
			
			// document.getElementById('rst').innerHTML = "apiKey=cb0c0b23-607a-4342-ab04-142ca8365e57&equationInput="+JSON.stringify(post)+"&userId=16000000000";
		},false);

		// var link = document.createElement("link");
		// link.href="./load.css";
		// link.rel = "stylesheet"
		// document.querySelector("head").insertBefore(link,document.querySelector("link"));

		// window.addEventListener("load",function(){
		// 	console.log("load"+new Date().getTime());
		// },false);
		// window.addEventListener("DOMContentLoaded",function(e){
		// 	console.log("con"+new Date().getTime());
		// },false)

	</script>
	
</body>
</html>